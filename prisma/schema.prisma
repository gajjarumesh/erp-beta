// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// MULTI-TENANCY & SUBSCRIPTION MODELS
// ==========================================

// Subscription Plans
model Plan {
  id             String         @id @default(cuid())
  name           String         @unique // free, starter, professional, enterprise
  displayName    String
  description    String?
  monthlyPrice   Decimal        @db.Decimal(10, 2) @default(0)
  yearlyPrice    Decimal        @db.Decimal(10, 2) @default(0)
  maxUsers       Int            @default(2)
  maxApps        Int            @default(1) // -1 for unlimited
  maxRecords     Int            @default(1000) // -1 for unlimited
  storageGb      Int            @default(1)
  features       Json?          // Additional features as JSON
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  subscriptions  Subscription[]
}

// Tenant/Organization Subscription
model Subscription {
  id              String             @id @default(cuid())
  companyId       String
  company         Company            @relation(fields: [companyId], references: [id])
  planId          String
  plan            Plan               @relation(fields: [planId], references: [id])
  status          SubscriptionStatus @default(TRIAL)
  billingCycle    BillingCycle       @default(MONTHLY)
  currentPeriodStart DateTime        @default(now())
  currentPeriodEnd   DateTime
  trialEndsAt     DateTime?
  cancelledAt     DateTime?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  payments        SubscriptionPayment[]
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

// Subscription Payments
model SubscriptionPayment {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])
  amount         Decimal      @db.Decimal(10, 2)
  currency       String       @default("USD")
  status         PaymentStatus @default(PENDING)
  paymentMethod  String?
  transactionId  String?
  invoiceUrl     String?
  paidAt         DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Available Apps/Modules
model App {
  id           String      @id @default(cuid())
  slug         String      @unique // sales, crm, inventory, etc.
  name         String
  description  String?
  icon         String?
  color        String?
  category     String      // Sales, Operations, Finance, HR, Marketing, Productivity
  monthlyPrice Decimal     @db.Decimal(10, 2) @default(0)
  isCore       Boolean     @default(false) // Core apps like Dashboard
  isActive     Boolean     @default(true)
  features     Json?       // App features as JSON
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  companyApps  CompanyApp[]
}

// Company's Installed Apps
model CompanyApp {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  appId       String
  app         App      @relation(fields: [appId], references: [id])
  installedAt DateTime @default(now())
  isActive    Boolean  @default(true)
  settings    Json?    // App-specific settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([companyId, appId])
}

// ==========================================
// USER & AUTHENTICATION
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  avatar        String?
  role          Role      @default(USER)
  companyId     String?
  company       Company?  @relation(fields: [companyId], references: [id])
  emailVerified DateTime?
  lastLoginAt   DateTime?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  employee      Employee?
  sessions      Session[]
  notifications UserNotification[]
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  userAgent    String?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime @default(now())
}

model UserNotification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  message   String
  type      String   // info, success, warning, error
  isRead    Boolean  @default(false)
  link      String?
  createdAt DateTime @default(now())
}

enum Role {
  SUPER_ADMIN // Platform admin
  ADMIN       // Company admin
  MANAGER
  USER
}

// ==========================================
// COMPANIES/ORGANIZATIONS (TENANTS)
// ==========================================

model Company {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique // URL-friendly identifier
  email         String?
  phone         String?
  website       String?
  address       String?
  city          String?
  state         String?
  postalCode    String?
  country       String?
  taxId         String?
  logo          String?
  timezone      String         @default("UTC")
  currency      String         @default("USD")
  dateFormat    String         @default("MM/DD/YYYY")
  fiscalYearStart Int          @default(1) // Month (1-12)
  settings      Json?          // Company-wide settings
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  // Subscription & Apps
  subscriptions Subscription[]
  installedApps CompanyApp[]
  // Core relations
  users         User[]
  employees     Employee[]
  departments   Department[]
  customers     Customer[]
  vendors       Vendor[]
  products      Product[]
  salesOrders   SalesOrder[]
  invoices      Invoice[]
  leads         Lead[]
  warehouses    Warehouse[]
  // Additional modules
  categories    Category[]
  quotations    Quotation[]
  projects      Project[]
  tasks         Task[]
  tickets       Ticket[]
  campaigns     Campaign[]
  auditLogs     AuditLog[]
}

// Products & Categories
model Category {
  id          String    @id @default(cuid())
  name        String
  description String?
  parentId    String?
  parent      Category? @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  companyId   String
  company     Company   @relation(fields: [companyId], references: [id])
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Product {
  id              String         @id @default(cuid())
  name            String
  sku             String         @unique
  description     String?
  categoryId      String?
  category        Category?      @relation(fields: [categoryId], references: [id])
  price           Decimal        @db.Decimal(10, 2)
  cost            Decimal        @db.Decimal(10, 2) @default(0)
  quantity        Int            @default(0)
  minQuantity     Int            @default(0)
  unit            String         @default("unit")
  isActive        Boolean        @default(true)
  companyId       String
  company         Company        @relation(fields: [companyId], references: [id])
  orderLines      OrderLine[]
  invoiceLines    InvoiceLine[]
  stockMoves      StockMove[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// Customers & Vendors
model Customer {
  id          String       @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  city        String?
  country     String?
  taxId       String?
  companyId   String
  company     Company      @relation(fields: [companyId], references: [id])
  salesOrders SalesOrder[]
  invoices    Invoice[]
  leads       Lead[]
  quotations  Quotation[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Vendor {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  city      String?
  country   String?
  taxId     String?
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Sales Orders & Order Lines
model SalesOrder {
  id           String      @id @default(cuid())
  orderNumber  String      @unique
  customerId   String
  customer     Customer    @relation(fields: [customerId], references: [id])
  companyId    String
  company      Company     @relation(fields: [companyId], references: [id])
  status       OrderStatus @default(DRAFT)
  orderDate    DateTime    @default(now())
  deliveryDate DateTime?
  subtotal     Decimal     @db.Decimal(10, 2) @default(0)
  tax          Decimal     @db.Decimal(10, 2) @default(0)
  total        Decimal     @db.Decimal(10, 2) @default(0)
  notes        String?
  orderLines   OrderLine[]
  invoices     Invoice[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

model OrderLine {
  id           String     @id @default(cuid())
  orderId      String
  order        SalesOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  quantity     Int
  unitPrice    Decimal    @db.Decimal(10, 2)
  discount     Decimal    @db.Decimal(5, 2) @default(0)
  subtotal     Decimal    @db.Decimal(10, 2)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

// Invoices & Payments
model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  customerId    String
  customer      Customer      @relation(fields: [customerId], references: [id])
  companyId     String
  company       Company       @relation(fields: [companyId], references: [id])
  orderId       String?
  order         SalesOrder?   @relation(fields: [orderId], references: [id])
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(10, 2) @default(0)
  tax           Decimal       @db.Decimal(10, 2) @default(0)
  total         Decimal       @db.Decimal(10, 2) @default(0)
  paidAmount    Decimal       @db.Decimal(10, 2) @default(0)
  notes         String?
  invoiceLines  InvoiceLine[]
  payments      Payment[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

model InvoiceLine {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  discount  Decimal @db.Decimal(5, 2) @default(0)
  subtotal  Decimal @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id            String        @id @default(cuid())
  invoiceId     String
  invoice       Invoice       @relation(fields: [invoiceId], references: [id])
  amount        Decimal       @db.Decimal(10, 2)
  paymentDate   DateTime      @default(now())
  paymentMethod PaymentMethod @default(CASH)
  reference     String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  CHECK
  OTHER
}

// Employees & Departments
model Department {
  id          String     @id @default(cuid())
  name        String
  description String?
  managerId   String?
  companyId   String
  company     Company    @relation(fields: [companyId], references: [id])
  employees   Employee[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Employee {
  id           String       @id @default(cuid())
  employeeId   String       @unique
  userId       String?      @unique
  user         User?        @relation(fields: [userId], references: [id])
  firstName    String
  lastName     String
  email        String
  phone        String?
  address      String?
  city         String?
  country      String?
  dateOfBirth  DateTime?
  hireDate     DateTime     @default(now())
  jobTitle     String?
  departmentId String?
  department   Department?  @relation(fields: [departmentId], references: [id])
  companyId    String
  company      Company      @relation(fields: [companyId], references: [id])
  salary       Decimal      @db.Decimal(10, 2) @default(0)
  isActive     Boolean      @default(true)
  attendances  Attendance[]
  leaves       Leave[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

model Attendance {
  id         String    @id @default(cuid())
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id])
  checkIn    DateTime
  checkOut   DateTime?
  workHours  Decimal?  @db.Decimal(4, 2)
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Leave {
  id          String      @id @default(cuid())
  employeeId  String
  employee    Employee    @relation(fields: [employeeId], references: [id])
  leaveType   LeaveType
  startDate   DateTime
  endDate     DateTime
  status      LeaveStatus @default(PENDING)
  reason      String?
  approvedBy  String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

enum LeaveType {
  ANNUAL
  SICK
  PERSONAL
  UNPAID
  OTHER
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Inventory & Stock Moves
model Warehouse {
  id         String      @id @default(cuid())
  name       String
  code       String      @unique
  address    String?
  city       String?
  country    String?
  companyId  String
  company    Company     @relation(fields: [companyId], references: [id])
  isActive   Boolean     @default(true)
  stockMoves StockMove[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
}

model StockMove {
  id           String        @id @default(cuid())
  productId    String
  product      Product       @relation(fields: [productId], references: [id])
  warehouseId  String
  warehouse    Warehouse     @relation(fields: [warehouseId], references: [id])
  moveType     StockMoveType
  quantity     Int
  reference    String?
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

enum StockMoveType {
  IN
  OUT
  TRANSFER
  ADJUSTMENT
}

// Leads & Opportunities (CRM)
model Lead {
  id           String     @id @default(cuid())
  name         String
  email        String?
  phone        String?
  company      String?
  source       LeadSource @default(OTHER)
  status       LeadStatus @default(NEW)
  customerId   String?
  customer     Customer?  @relation(fields: [customerId], references: [id])
  companyId    String
  companyRef   Company    @relation(fields: [companyId], references: [id])
  expectedValue Decimal?  @db.Decimal(10, 2)
  probability   Int?      @default(0)
  notes        String?
  assignedTo   String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  EMAIL_CAMPAIGN
  COLD_CALL
  TRADE_SHOW
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

// ==========================================
// ADDITIONAL MODULES
// ==========================================

// Quotations
model Quotation {
  id            String          @id @default(cuid())
  quotationNo   String          @unique
  customerId    String
  customer      Customer        @relation(fields: [customerId], references: [id])
  companyId     String
  company       Company         @relation(fields: [companyId], references: [id])
  status        QuotationStatus @default(DRAFT)
  validUntil    DateTime
  subtotal      Decimal         @db.Decimal(10, 2) @default(0)
  tax           Decimal         @db.Decimal(10, 2) @default(0)
  total         Decimal         @db.Decimal(10, 2) @default(0)
  discount      Decimal         @db.Decimal(10, 2) @default(0)
  notes         String?
  terms         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  lines         QuotationLine[]
}

enum QuotationStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
  CONVERTED
}

model QuotationLine {
  id          String    @id @default(cuid())
  quotationId String
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  productId   String
  productName String
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  discount    Decimal   @db.Decimal(5, 2) @default(0)
  subtotal    Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// Projects & Tasks
model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  companyId   String
  company     Company       @relation(fields: [companyId], references: [id])
  status      ProjectStatus @default(PLANNING)
  priority    Priority      @default(MEDIUM)
  startDate   DateTime?
  endDate     DateTime?
  budget      Decimal?      @db.Decimal(10, 2)
  managerId   String?
  progress    Int           @default(0) // 0-100
  color       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  tasks       Task[]
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  projectId   String?
  project     Project?   @relation(fields: [projectId], references: [id])
  companyId   String
  company     Company    @relation(fields: [companyId], references: [id])
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  assigneeId  String?
  dueDate     DateTime?
  estimatedHours Decimal? @db.Decimal(5, 2)
  actualHours    Decimal? @db.Decimal(5, 2)
  tags        String[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

// Helpdesk Tickets
model Ticket {
  id          String       @id @default(cuid())
  ticketNo    String       @unique
  subject     String
  description String
  companyId   String
  company     Company      @relation(fields: [companyId], references: [id])
  status      TicketStatus @default(OPEN)
  priority    Priority     @default(MEDIUM)
  category    String?
  customerId  String?
  assigneeId  String?
  resolution  String?
  resolvedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

// Marketing Campaigns
model Campaign {
  id          String         @id @default(cuid())
  name        String
  description String?
  companyId   String
  company     Company        @relation(fields: [companyId], references: [id])
  type        CampaignType   @default(EMAIL)
  status      CampaignStatus @default(DRAFT)
  startDate   DateTime?
  endDate     DateTime?
  budget      Decimal?       @db.Decimal(10, 2)
  spent       Decimal?       @db.Decimal(10, 2) @default(0)
  targetAudience String?
  metrics     Json?          // Opens, clicks, conversions, etc.
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}

enum CampaignType {
  EMAIL
  SOCIAL
  ADS
  EVENTS
  CONTENT
  OTHER
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

// Audit Logs
model AuditLog {
  id          String   @id @default(cuid())
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  userId      String?
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity      String   // Model name
  entityId    String?
  changes     Json?    // Before/after data
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}

// ==========================================
// PHASE 5: POS, BI & WORKFLOW ENGINE
// ==========================================

// POS (Point of Sale)
model PosSession {
  id              String         @id @default(cuid())
  companyId       String?
  openedByUserId  String
  openedAt        DateTime       @default(now())
  closedAt        DateTime?
  openingBalance  Decimal        @db.Decimal(10, 2) @default(0)
  closingBalance  Decimal?       @db.Decimal(10, 2)
  status          PosSessionStatus @default(OPEN)
  notes           String?
  transactions    PosTransaction[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

enum PosSessionStatus {
  OPEN
  CLOSED
}

model PosTransaction {
  id             String     @id @default(cuid())
  sessionId      String
  session        PosSession @relation(fields: [sessionId], references: [id])
  receiptNumber  String     @unique
  companyId      String?
  items          Json       // Array of {productId, name, quantity, unitPrice, subtotal}
  totalAmount    Decimal    @db.Decimal(10, 2)
  paymentMethod  PaymentMethod @default(CASH)
  changeGiven    Decimal    @db.Decimal(10, 2) @default(0)
  customerId     String?
  notes          String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

// BI & Reporting
model SavedReport {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  config      Json     // Report configuration: query, filters, visualization type
  category    String?  // Revenue, Inventory, Sales, HR, etc.
  isActive    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DashboardWidget {
  id          String   @id @default(cuid())
  userId      String   // Widget belongs to a user
  name        String
  type        String   // chart, table, metric, list
  config      Json     // Widget configuration: data source, visualization settings
  position    Json     // {x: 0, y: 0, width: 4, height: 3}
  reportSlug  String?  // Link to saved report
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Workflow Engine
model WorkflowRule {
  id          String        @id @default(cuid())
  companyId   String
  name        String
  description String?
  trigger     Json          // {type: "on_create|on_update|on_delete|schedule|webhook", entity: "invoice", config: {...}}
  conditions  Json          // JSON-based conditions: {field: "due_date", operator: "<", value: "now"}
  actions     Json          // Array of actions: [{type: "send_email", config: {...}}]
  isActive    Boolean       @default(true)
  runsCount   Int           @default(0)
  lastRunAt   DateTime?
  createdBy   String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  logs        WorkflowLog[]
}

model WorkflowLog {
  id              String          @id @default(cuid())
  workflowId      String
  workflow        WorkflowRule    @relation(fields: [workflowId], references: [id])
  status          WorkflowLogStatus @default(PENDING)
  runAt           DateTime        @default(now())
  inputSnapshot   Json?           // Snapshot of entity data that triggered workflow
  outputSnapshot  Json?           // Result of actions executed
  errorMessage    String?
  executionTime   Int?            // Milliseconds
  createdAt       DateTime        @default(now())
}

enum WorkflowLogStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  RETRY
}
